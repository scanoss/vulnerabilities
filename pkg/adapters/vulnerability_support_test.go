package adapters

import (
	"fmt"
	"testing"

	_ "github.com/mattn/go-sqlite3"
	pb "github.com/scanoss/papi/api/vulnerabilitiesv2"
	zlog "github.com/scanoss/zap-logging-helper/pkg/logger"

	"scanoss.com/vulnerabilities/pkg/dtos"
)

func TestVulnOutputToVulnerabilityResponse(t *testing.T) {
	err := zlog.NewSugaredDevLogger()
	if err != nil {
		t.Fatalf("an error '%s' was not expected when opening a sugared logger", err)
	}
	defer zlog.SyncZap()

	var outputDto = dtos.VulnerabilityOutput{}

	output, err := FromVulnerabilityOutputToVulnerabilityResponse(outputDto)
	if err != nil {
		t.Errorf("TestOutputConvert failed: %v", err)
	}
	fmt.Printf("Output: %v\n", output)
}

func TestFromCpeComponentOutputTOCpeResponse(t *testing.T) {
	err := zlog.NewSugaredDevLogger()
	if err != nil {
		t.Fatalf("an error '%s' was not expected when opening a sugared logger", err)
	}
	defer zlog.SyncZap()
	var outputDto = []dtos.CpeComponentOutput{}
	output, err := FromCpeComponentOutputTOCpeResponse(outputDto)
	if err != nil {
		t.Errorf("TestCpeOutputConvert failed: %v", err)
	}
	fmt.Printf("Output: %v\n", output)
}

func TestVulnerabilityRequestToComponentDTO(t *testing.T) {
	err := zlog.NewSugaredDevLogger()
	if err != nil {
		t.Fatalf("an error '%s' was not expected when opening a sugared logger", err)
	}
	defer zlog.SyncZap()
	tests := []struct {
		input             *pb.VulnerabilityRequest
		expectError       bool
		name              string
		validComponents   []dtos.ComponentDTO
		invalidComponents []dtos.ComponentDTO
	}{
		{
			input:             &pb.VulnerabilityRequest{},
			expectError:       true,
			name:              "Empty request",
			validComponents:   []dtos.ComponentDTO{},
			invalidComponents: []dtos.ComponentDTO{},
		},
		{
			input: &pb.VulnerabilityRequest{Purls: []*pb.VulnerabilityRequest_Purls{
				{
					Purl: "g:golang/example@1.0.0",
				},
				{
					Purl: "pkg:github/lodash@4.17.21",
				},
			}},
			expectError: false,
			name:        "Valid request",
			validComponents: []dtos.ComponentDTO{
				{
					Purl: "pkg:github/lodash@4.17.21",
				},
			},
			invalidComponents: []dtos.ComponentDTO{
				{
					Purl: "g:golang/example@1.0.0",
				},
			},
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {

			components, invalidComponents, err := FromVulnerabilityRequestToComponentDTO(tt.input)

			if tt.expectError && err == nil {
				t.Error("expected error but got none")
			}
			if !tt.expectError && err != nil {
				t.Errorf("unexpected error: %v", err)
			}

			if len(components) != len(tt.validComponents) {
				t.Errorf("expected %d components but got %d", len(tt.validComponents), len(components))
			}
			if len(invalidComponents) != len(tt.invalidComponents) {
				t.Errorf("expected %d invalid components but got %d", len(tt.invalidComponents), len(invalidComponents))
			}
		})
	}
}

func TestVulnerabilityOutputToComponentVulnerabilityResponse(t *testing.T) {
	err := zlog.NewSugaredDevLogger()
	if err != nil {
		t.Fatalf("an error '%s' was not expected when opening a sugared logger", err)
	}
	defer zlog.SyncZap()
	input := dtos.VulnerabilityOutput{
		Components: []dtos.VulnerabilityComponentOutput{
			{
				Purl:            "pkg:github/scanoss/scanoss.js",
				Requirement:     ">=0.16.0",
				Version:         "0.17:0",
				Vulnerabilities: make([]dtos.VulnerabilitiesOutput, 0),
			},
		},
	}
	response, err := FromVulnerabilityOutputToComponentVulnerabilityResponse(input)
	if err != nil {
		t.Errorf("TestOutputConvert failed: %v", err)
	}
	if response.Component.Purl != input.Components[0].Purl {
		t.Errorf("Expected %s but got %s", input.Components[0].Purl, response.Component.Purl)
	}
	if response.Component.Requirement != input.Components[0].Requirement {
		t.Errorf("Expected %s but got %s", input.Components[0].Requirement, response.Component.Requirement)
	}
	if response.Component.Version != input.Components[0].Version {
		t.Errorf("Expected %s but got %s", input.Components[0].Version, response.Component.Version)
	}
}

func TestVulnerabilityOutputToComponentsVulnerabilityResponse(t *testing.T) {
	err := zlog.NewSugaredDevLogger()
	if err != nil {
		t.Fatalf("an error '%s' was not expected when opening a sugared logger", err)
	}
	defer zlog.SyncZap()

	tests := []struct {
		name          string
		input         dtos.VulnerabilityOutput
		expectError   bool
		expectedCount int
	}{
		{
			name: "Multiple components with empty vulnerabilities",
			input: dtos.VulnerabilityOutput{
				Components: []dtos.VulnerabilityComponentOutput{
					{
						Purl:            "pkg:github/scanoss/scanoss.js",
						Requirement:     ">=0.16.0",
						Version:         "0.17:0",
						Vulnerabilities: make([]dtos.VulnerabilitiesOutput, 0),
					},
					{
						Purl:            "pkg:github/scanoss/scanoss.py",
						Requirement:     ">=0.30.0",
						Version:         "0.31:0",
						Vulnerabilities: make([]dtos.VulnerabilitiesOutput, 0),
					},
				},
			},
			expectError:   false,
			expectedCount: 2,
		},
		{
			name: "Single component with vulnerabilities",
			input: dtos.VulnerabilityOutput{
				Components: []dtos.VulnerabilityComponentOutput{
					{
						Purl:        "pkg:npm/lodash@4.17.20",
						Requirement: "4.17.20",
						Version:     "4.17.20",
						Vulnerabilities: []dtos.VulnerabilitiesOutput{
							{
								ID:       "GHSA-35jh-r3h4-6jhm",
								Cve:      "CVE-2021-23337",
								URL:      "https://github.com/advisories/GHSA-35jh-r3h4-6jhm",
								Summary:  "Command injection vulnerability",
								Severity: "HIGH",
								Source:   "github",
							},
						},
					},
				},
			},
			expectError:   false,
			expectedCount: 1,
		},
		{
			name: "Empty components",
			input: dtos.VulnerabilityOutput{
				Components: []dtos.VulnerabilityComponentOutput{},
			},
			expectError:   false,
			expectedCount: 0,
		},
		{
			name: "Component with multiple vulnerabilities",
			input: dtos.VulnerabilityOutput{
				Components: []dtos.VulnerabilityComponentOutput{
					{
						Purl:        "pkg:maven/org.apache.struts/struts2-core@2.3.34",
						Requirement: "2.3.34",
						Version:     "2.3.34",
						Vulnerabilities: []dtos.VulnerabilitiesOutput{
							{
								ID:       "CVE-2017-5638",
								Cve:      "CVE-2017-5638",
								URL:      "https://nvd.nist.gov/vuln/detail/CVE-2017-5638",
								Summary:  "Remote code execution via content-type header",
								Severity: "CRITICAL",
								Source:   "nvd",
							},
							{
								ID:       "CVE-2017-9791",
								Cve:      "CVE-2017-9791",
								URL:      "https://nvd.nist.gov/vuln/detail/CVE-2017-9791",
								Summary:  "XSS vulnerability in Struts 1 plugin",
								Severity: "MEDIUM",
								Source:   "nvd",
							},
						},
					},
				},
			},
			expectError:   false,
			expectedCount: 1,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			response, err := FromVulnerabilityOutputToComponentsVulnerabilityResponse(tt.input)

			if tt.expectError && err == nil {
				t.Error("expected error but got none")
			}
			if !tt.expectError && err != nil {
				t.Errorf("unexpected error: %v", err)
			}

			if !tt.expectError {
				if response == nil {
					t.Fatal("expected response but got nil")
				}
				if len(response.Components) != tt.expectedCount {
					t.Errorf("expected %d components but got %d", tt.expectedCount, len(response.Components))
				}

				if tt.expectedCount > 0 && len(tt.input.Components) > 0 {

					for i, r := range response.Components {
						inputComponent := tt.input.Components[i]

						if r.Purl != inputComponent.Purl {
							t.Errorf("Expected purl %s but got %s", inputComponent.Purl, r.Purl)
						}
						if r.Requirement != inputComponent.Requirement {
							t.Errorf("Expected requirement %s but got %s", inputComponent.Requirement,
								r.Requirement)
						}
						if r.Version != inputComponent.Version {
							t.Errorf("Expected version %s but got %s", inputComponent.Version, r.Version)
						}
						if len(r.Vulnerabilities) != len(inputComponent.Vulnerabilities) {
							t.Errorf("Expected %d vulnerabilities but got %d",
								len(inputComponent.Vulnerabilities), len(r.Vulnerabilities))
						}
					}
				}
			}
		})
	}
}
