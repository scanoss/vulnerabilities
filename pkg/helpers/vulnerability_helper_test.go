// SPDX-License-Identifier: GPL-2.0-or-later
/*
 * Copyright (C) 2018-2025 SCANOSS.COM
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

package helpers

import (
	"scanoss.com/vulnerabilities/pkg/dtos"
	"scanoss.com/vulnerabilities/pkg/utils"
	"testing"
)

func TestMergeVulnerabilities(t *testing.T) {
	osvResults := dtos.VulnerabilityOutput{
		Purls: []dtos.VulnerabilityPurlOutput{
			{
				Purl: "pkg:pypi/mlflow@2.3.0",
				Vulnerabilities: []dtos.VulnerabilitiesOutput{
					{
						Id:        "GHSA-3v79-q7ph-j75h",
						Cve:       "BIT-mlflow-2024-27133",
						Url:       "https://test.osv.dev/vulnerability/BIT-mlflow-2024-27133",
						Summary:   "MLFlow Cross-site Scripting vulnerability leads to client-side Remote Code Execution",
						Severity:  "CRITICAL",
						Published: utils.OnlyDate(utils.ParseTime("2024-02-24")),
						Modified:  utils.OnlyDate(utils.ParseTime("2025-01-22")),
						Source:    "OSV",
					},
					{
						Id:        "GHSA-43c4-9qgj-x742",
						Cve:       "BIT-mlflow-2024-37053",
						Url:       "https://test.osv.dev/vulnerability/BIT-mlflow-2024-37053",
						Summary:   "MLFlow unsafe deserialization",
						Severity:  "HIGH",
						Published: utils.OnlyDate(utils.ParseTime("2024-06-04")),
						Modified:  utils.OnlyDate(utils.ParseTime("2024-10-22")),
						Source:    "OSV",
					},
					{
						Id:        "GHSA-5q6c-ffvg-xcm9",
						Cve:       "BIT-mlflow-2024-0520",
						Url:       "https://test.osv.dev/vulnerability/BIT-mlflow-2024-0520",
						Summary:   "Remote code execution in mlflow",
						Severity:  "CRITICAL",
						Published: utils.OnlyDate(utils.ParseTime("2024-06-06")),
						Modified:  utils.OnlyDate(utils.ParseTime("2024-10-14")),
						Source:    "OSV",
					},
					{
						Id:        "PYSEC-2023-280",
						Cve:       "BIT-mlflow-2023-4033",
						Url:       "https://test.osv.dev/vulnerability/BIT-mlflow-2023-4033",
						Summary:   "",
						Severity:  "",
						Published: utils.OnlyDate(utils.ParseTime("2023-08-01")),
						Modified:  utils.OnlyDate(utils.ParseTime("2024-11-21")),
						Source:    "OSV",
					},
				},
			},
		},
	}

	localResults := dtos.VulnerabilityOutput{
		Purls: []dtos.VulnerabilityPurlOutput{
			{
				Purl: "pkg:pypi/mlflow@2.3.0",
				Vulnerabilities: []dtos.VulnerabilitiesOutput{
					{
						Id:        "GHSA-43c4-9qgj-x742",
						Cve:       "BIT-mlflow-2024-37053",
						Url:       "https://test.osv.dev/vulnerability/BIT-mlflow-2024-37053",
						Summary:   "MLFlow unsafe deserialization",
						Severity:  "HIGH",
						Published: utils.OnlyDate(utils.ParseTime("2024-06-04")),
						Modified:  utils.OnlyDate(utils.ParseTime("2024-10-22")),
						Source:    "NDV",
					},
					{
						Id:        "GHSA-5q6c-ffvg-xcm9",
						Cve:       "BIT-mlflow-2024-0520",
						Url:       "https://test.osv.dev/vulnerability/BIT-mlflow-2024-0520",
						Summary:   "Remote code execution in mlflow",
						Severity:  "CRITICAL",
						Published: utils.OnlyDate(utils.ParseTime("2024-06-06")),
						Modified:  utils.OnlyDate(utils.ParseTime("2024-10-14")),
						Source:    "NDV",
					},
				},
			},
		},
	}

	mergedResults := MergeOSVAndLocalVulnerabilities(localResults, osvResults)

	vulnerabilities := make(map[string]dtos.VulnerabilitiesOutput)
	for _, r := range mergedResults.Purls {
		for _, v := range r.Vulnerabilities {
			vulnerabilities[v.Cve] = v
		}
	}

	if len(vulnerabilities) != 4 {
		t.Errorf("Expected length %d, but got %d", 4, len(vulnerabilities))
	}

}
